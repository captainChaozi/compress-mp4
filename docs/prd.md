# MVP 功能规格 — Offline MP4 Compressor

> **READY FOR IMPLEMENTATION**（无 P0/P1 阻塞项）

## 0. 概览

### 目标与成功指标

- **全程离线**完成 MP4 压缩：不登录、不上传、不依赖网络服务。
- 用户可通过“压缩比率”直观控制输出体积，并完成**预览对比 → 导出**闭环。
- 成功指标（可验收）：
  - 任意 MP4 输入可走通主流程并导出文件（在设备资源允许范围内）。
  - 输出文件可播放（基础可用性）。
  - 输出体积与目标体积比例在**默认容差范围**内（见验收标准）。

### 非目标（不做什么）

- 不做账号体系、云端同步、分享/发布、历史记录、批量处理、任务队列。
- 不提供多格式导出（仅导出 MP4）。
- 不承诺“无限大文件一定成功”（产品不限制大小，但受设备资源影响，失败需有明确提示）。

### 主用户与关键场景

- 主用户：手头没有合适视频压缩工具、需要快速离线压缩 MP4 的用户。
- 关键场景：从本地选择一个视频，调压缩比率，等待处理，查看对比效果后导出。

---

## 1. MVP 范围

### In scope（做什么）

- 单页离线 MP4 压缩工具：
  1. 选择本地视频文件
  2. 设置压缩比率（滑杆 + 预设）
  3. 开始压缩（显示状态与耗时）
  4. 对比预览（输入 vs 输出）
  5. 导出 MP4（可改名）

### Out of scope（不做什么）

- 批量/并行任务
- 历史记录/最近文件
- 上传云端、分享链接
- 高级编码参数（除“压缩比率”外的专业参数）

### 硬约束

- 全离线、不登录、不上传
- 最大文件大小：**产品侧不限制**
- 仅导出：**MP4**
- 一次只处理：**1 个文件**

---

## 2. 用户旅程（端到端）

### 旅程 1：离线压缩并导出

1. 用户进入页面（初始态）
2. 用户选择本地视频文件（尽量支持多扩展名）
3. 系统解析并展示输入信息（大小/时长/分辨率等）
4. 用户设置压缩比率（滑杆或点预设）
5. 用户点击“开始压缩”
6. 系统进入处理中状态（展示“处理中”+已用时间；允许取消）
7. 成功后进入结果态：展示输出信息 + 对比预览
8. 用户点击导出，修改文件名（可选），保存输出 MP4

失败分支（如有）

- 选中文件无法读取/不支持 → 错误态提示原因，可重新选择
- 压缩过程中失败 → 错误态提示原因，提供“重试”与“重新选择文件”
- 用户取消 → 回到“已选择文件但未开始”的状态（不生成输出文件）

---

## 3. 页面与交互

## 3.1 页面：Offline MP4 Compressor（单页）

### 目的

让用户离线完成单个视频的压缩、预览对比并导出 MP4。

### 入口

- 直接访问该页面（无需登录）。

### UI 组件（概念层面）

- 文件选择区：按钮“选择视频文件” + 显示已选文件名
- 输入信息卡：大小、时长、分辨率（若可取到）
- 压缩设置区：
  - 压缩比率滑杆（1%–100% 或等价区间）
  - 预设按钮：**80% / 60% / 40% / 20%**
  - 默认值：**60%**

- 主操作按钮：
  - “开始压缩”
  - “取消”（仅处理中显示）

- 处理中信息：
  - 状态文案：处理中
  - 已用时间（秒/分）

- 结果区：
  - 输出信息卡：输出大小、压缩比（实际）、时长、分辨率
  - 对比预览区：输入/输出对比（见下）
  - 导出按钮：“导出 MP4” + 文件名输入框（可选修改）

---

### UI 状态机（必须可验收）

#### 状态 S0：Empty（未选择文件）

- 触发条件：页面首次进入；或用户清除选择/处理失败后主动返回
- UI 呈现：只显示“选择视频文件”与说明文案
- 允许操作：选择文件
- 系统响应：进入 S1 或 S3（取决于是否可解析）
- 退出条件：成功选择并解析文件

#### 状态 S1：Success（已选择文件，未开始）

- 触发条件：选择文件成功且可读取基本信息
- UI 呈现：展示输入信息 + 压缩比率设置 + “开始压缩”
- 允许操作：
  - 调整滑杆/点击预设（更新当前目标比例）
  - 点击开始压缩
  - 重新选择文件（覆盖）

- 系统响应：
  - 开始压缩 → S2
  - 重新选择 → 仍 S1（替换输入）

- 退出条件：用户点击开始压缩或更换文件

#### 状态 S2：Loading（处理中）

- 触发条件：用户点击“开始压缩”
- UI 呈现：禁用设置；显示“处理中”+已用时间；显示“取消”
- 允许操作：
  - 取消（B：允许取消）

- 系统响应：
  - 成功完成 → S4
  - 失败 → S3
  - 取消 → 回到 S1（不生成输出文件）

- 退出条件：成功/失败/取消

#### 状态 S3：Error（错误）

- 触发条件：
  - 文件不支持/读取失败
  - 压缩失败（资源不足、文件损坏等）

- UI 呈现：
  - 错误标题 + 可理解原因（用户可行动）
  - 按钮：重试（若已有输入） / 重新选择文件

- 允许操作：重试 / 重新选择文件
- 系统响应：
  - 重试 → S2
  - 重新选择 → S1 或 S0

- 退出条件：重试或更换文件

#### 状态 S4：Success（已完成，有输出）

- 触发条件：压缩成功产出输出文件
- UI 呈现：
  - 输出信息卡（含“目标 vs 实际”）
  - 对比预览区
  - 导出区（默认文件名可改）

- 允许操作：
  - 对比预览播放/切换（见规则）
  - 导出
  - 调整压缩比率并再次压缩（回到 S2）
  - 重新选择文件（回到 S1）

- 系统响应：对应动作更新状态
- 退出条件：用户再次压缩/换文件/离开页面

---

### 用户动作（完整列表）

- 选择文件
- 调整压缩比率（滑杆/预设）
- 开始压缩
- 取消压缩
- 重试
- 对比预览播放/切换
- 修改导出文件名
- 导出 MP4
- 重新选择文件

### 系统响应（完整列表）

- 解析输入文件信息并展示
- 根据目标比例执行压缩（含自动降分辨率策略）
- 生成输出并可预览
- 导出时提供默认命名并允许修改
- 对错误给出原因与可行动建议

### 边界情况

- 超大文件导致处理失败或耗时很长：进入 Error，提示“设备资源不足/内存不足/处理失败”并建议降低目标压缩强度或关闭其他应用后重试。
- 文件损坏/无法解码：Error 提示“文件无法读取/已损坏”。
- 用户在处理中关闭页面/刷新：默认不恢复任务（无历史/无持久化）。

---

## 4. 核心数据对象（仅语义）

### 4.1 InputFile

- 定义：用户选择的本地视频文件。
- 唯一标识规则：本次会话内用“文件选择实例”标识（无需跨会话唯一）。
- 关键字段：
  - name（字符串）
  - size_bytes（整数）
  - duration_seconds（数值，若可获取）
  - resolution（宽/高，若可获取）
  - mime_type / extension（字符串，若可获取）

- 生命周期：选中 → 被处理/被替换 → 丢弃

### 4.2 CompressionSettings

- 定义：用户对本次压缩的可见设置。
- 唯一标识规则：与当前任务绑定。
- 关键字段：
  - target_ratio（0–1 或 1–100%）
  - preset_used（可空：80/60/40/20）
  - auto_resolution（固定 true，因你选 C）

- 生命周期：调整中 → 锁定（处理中）→ 可再次修改

### 4.3 CompressionTask（会话内）

- 定义：一次压缩过程的任务实体（不持久化历史）。
- 唯一标识规则：会话内自增/UUID（仅用于状态管理）。
- 关键字段：
  - status：idle | running | cancelled | success | error
  - started_at / ended_at（用于已用时间）
  - error_reason（可空）

- 生命周期：创建 → running → success/error/cancelled → 丢弃

### 4.4 OutputFile

- 定义：压缩后的输出文件（会话内可导出）。
- 唯一标识规则：与任务绑定。
- 关键字段：
  - size_bytes
  - duration_seconds
  - resolution
  - actual_ratio（输出/输入）
  - export_filename_default

- 生命周期：生成 → 预览 → 导出 → 可被新任务覆盖

---

## 5. 业务规则

### 5.1 压缩比率（目标体积比例）

- 用户选择的“压缩比率”表示：**期望输出大小 ≈ 输入大小 × X%**。
- 预设值：80% / 60% / 40% / 20%，默认 60%。

### 5.2 目标命中规则（验收口径）

- 默认采用：**“尽量接近目标（允许误差）”**
  - 容差：默认 **±10%**（可覆写，见默认决定）。
  - 结果页必须展示：目标大小（输入×X%）与实际输出大小、实际比例。

### 5.3 自动降分辨率策略（优先保体积）

- 你选择了 **B：优先保体积**。因此规则口径为：
  - 当为了命中目标体积需要牺牲清晰度时，允许**自动降低分辨率**。

- 具体“阈值分段”作为默认决定（可覆写，见第 8 节）。

### 5.4 音频策略

- 默认：**压缩音频开启**（用户不需要在 MVP 中配置）。

### 5.5 取消策略

- 用户取消后：任务停止，**不生成输出文件**，回到可重新开始的状态。

### 5.6 输入文件扩展名支持

- 目标：**尽量支持更多视频扩展名**。
- 验收口径：允许用户选择常见视频扩展名；若某文件最终不被支持，必须在开始处理时进入 Error 并给出可理解提示（例如“该视频格式无法在当前环境离线处理，请尝试 MP4”）。

---

## 6. 错误处理策略（产品层面）

### 错误类别

- 文件选择/读取失败（权限、文件损坏）
- 不支持的格式/编码（无法解析）
- 处理失败（资源不足、内部失败）
- 用户取消（非错误）

### 重试策略

- **不自动重试**。
- 提供“重试”按钮：
  - 仅当仍有同一 InputFile + Settings 时可用。

### 面向用户的信息展示规则

- 错误信息必须包含：
  - 人可读原因（避免技术术语）
  - 用户可行动建议：重试 / 重新选择文件 / 提示换成 MP4

- 处理中必须显示：
  - “处理中” + 已用时间
  - “取消”

### 可观测性期望（结果描述，不选工具）

- 记录（在本地运行时可供调试查看的）关键事件：开始/成功/失败原因/取消；不包含用户文件内容。

---

## 7. 验收标准

> 采用 Given/When/Then。以下均以“离线环境”作为前置条件。

### 7.1 选择文件与设置

- Given 用户在页面空状态
  When 选择一个视频文件
  Then 显示文件名与输入信息卡（至少包含大小；如可获取则含时长/分辨率）

- Given 已选择文件
  When 点击预设 40%
  Then 滑杆与当前目标比率显示为 40%

### 7.2 压缩与取消

- Given 已选择文件且目标比率为 60%
  When 点击“开始压缩”
  Then 进入 Loading 状态，显示“处理中”与已用时间，并显示“取消”

- Given 正在处理中
  When 用户点击“取消”
  Then 任务停止，回到“已选择文件未开始”状态，且不产生可导出的输出文件

### 7.3 成功结果与命中规则

- Given 输入文件大小为 S，目标比率为 X%
  When 压缩成功
  Then 结果页展示：
  - 目标大小 = S×X%
  - 实际输出大小 S'
  - 实际比例 = S'/S
    And 实际比例落在 **X% ±10%** 的默认容差内（若不在容差内，仍算成功但必须提示“未命中目标，已尽力压缩/建议调高比率或接受更低画质”，此为默认决定可覆写）

### 7.4 对比预览

- Given 压缩成功进入结果页
  When 用户进行对比预览操作
  Then 能完成输入/输出对比预览（交互细节见第 8 节默认决定，可覆写）

### 7.5 导出

- Given 压缩成功且在结果页
  When 用户点击“导出 MP4”
  Then 导出文件扩展名为 `.mp4`
  And 默认文件名为 `原文件名-compressed.mp4`
  And 用户可修改导出文件名再导出

### 7.6 错误态

- Given 用户选择一个不支持的文件
  When 开始处理或解析失败
  Then 进入 Error 状态，展示原因与“重新选择文件”
  And 若存在可重试条件则展示“重试”

---

## 8. 默认决定（Default Decisions，可覆写）

### D1：一次只处理 1 个文件

- 默认内容：不支持批量/队列/并行。
- 理由：MVP 聚焦主流程稳定。
- 可覆写点：增加批量；影响面：状态机、错误处理、验收标准大幅增加。

### D2：页面状态集合

- 默认内容：S0 Empty / S1 Success(ready) / S2 Loading / S3 Error / S4 Success(done)。
- 理由：覆盖可验收的最小状态机。
- 可覆写点：增加更细分状态（如“解析中/导出中/部分成功”）；影响面：UI 与验收用例增加。

### D3：不自动重试

- 默认内容：错误只提供“重试”按钮，不自动重试。
- 理由：离线处理的失败原因多为资源/文件问题，自动重试可能徒增等待。
- 可覆写点：支持自动重试 1 次；影响面：Loading 行为与错误提示需变更。

### D4：目标命中容差

- 默认内容：目标体积命中容差 **±10%**。
- 理由：离线压缩受内容复杂度影响，严格命中会导致不可预期的失败或极端画质损失。
- 可覆写点：改为 ±5% 或 “必须 ≤ 目标”；影响面：成功判定与提示文案、失败策略改变。

### D5：自动降分辨率分段（当前未被你显式指定，作为默认可改）

- 默认内容（建议值）：
  - X ≥ 60%：尽量不降分辨率
  - 40% ≤ X < 60%：必要时降 1 档（如 4K→1080p、1080p→720p）
  - X < 40%：允许降到 720p 或更低以优先命中体积

- 理由：你选择“优先保体积”，需要清晰的分段规则以可测试。
- 可覆写点：你给出明确阈值与目标分辨率表；影响面：结果画质与命中率、对比预览体验变化。

### D6：对比预览交互（你选了 Q5=C 但未给定具体形态，作为默认可改）

- 默认内容：**单播放器 A/B 一键切换**（更易稳定验收）；提供“查看输入/查看输出”切换按钮。
- 理由：并排同时播放对性能与同步要求更高，MVP 更容易出现边界问题。
- 可覆写点：改为并排播放或加入同步；影响面：预览区域 UI、性能表现、验收用例增加。

### D7：输入扩展名支持范围（“尽量多”落地为默认列表）

- 默认内容：文件选择器允许常见视频扩展名（例如 mp4/mov/mkv/webm/avi 等）；不承诺全部一定可处理，失败则进入 Error 并提示建议使用 MP4。
- 理由：满足“尽量多扩展”的产品目标，同时保留可解释的失败路径。
- 可覆写点：改为“仅 MP4 承诺支持”；影响面：错误率、用户预期与提示文案变化。

### D8：压缩模式策略（ISSUE-004 决策）

- 默认内容：**单 Pass CRF 模式 + 估算**。
- 理由：MVP 优先保证速度，CRF 模式能保证画质底线，体积偏差在 ±10-20% 可接受。避免 2-pass 带来的双倍耗时。

### D9：视频元信息获取方式（ISSUE-004 决策）

- 默认内容：**使用 HTML5 `<video>` 标签加载元数据**。
- 理由：无需等待 WASM 初始化即可快速响应 UI，提升用户体验。

### D10：进度展示策略（ISSUE-004 决策）

- 默认内容：**同时显示“已用时间”和“百分比进度”**。
- 理由：提供更明确的等待预期，百分比通过 `FFmpeg time / duration` 计算。

### D11：对比预览交互（ISSUE-004 决策）

- 默认内容：**按钮切换源（互斥播放）**。
- 理由：实现简单，避免双播放器同步带来的性能开销和复杂的同步逻辑。

---

## 9. Open Items

- 无（P0/P1 已闭合；其余均以默认决定形式可覆写）。
