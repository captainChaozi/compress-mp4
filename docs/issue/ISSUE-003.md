# ISSUE-003: 完成一次端到端压缩 POC

## 背景 / 问题

根据 [PRD](file:///Users/chao/mvp/compressmp4/docs/prd.md)，产品需要**全程离线**完成 MP4 压缩。在正式实现完整 UI 状态机之前，需要通过技术 POC 验证离线压缩的核心流程可行性。

当前项目已完成：

- ISSUE-001：Next.js 项目初始化 ✅
- ISSUE-002：FFmpeg.wasm 环境配置（部分完成）
  - `@ffmpeg/ffmpeg`、`@ffmpeg/util`、`@ffmpeg/core-mt` 依赖已安装
  - COOP/COEP 响应头已配置
  - `useFFmpeg` Hook 已封装

本任务聚焦于**最小闭环验证**：从选择文件到导出压缩后视频的完整流程。

---

## 目标（Goals）

1. 验证 FFmpeg.wasm 在浏览器中执行视频压缩的技术可行性
2. 实现从文件选择 → 元信息读取 → 压缩执行 → 进度监听 → 导出 Blob URL 的完整链路
3. 验证 CRF 参数对输出质量/体积的影响
4. 确认压缩后文件体积确实小于原文件

---

## 非目标（Non-goals）

- **不**实现完整的 UI 状态机（S0/S1/S2/S3/S4）
- **不**实现取消压缩功能
- **不**实现目标码率精确控制（仅验证 CRF）
- **不**处理大文件边界情况（内存不足等）
- **不**支持非 MP4 格式输入
- **不**实现错误恢复/重试机制
- **不**实现对比预览功能

---

## 范围（Scope）

### 包含

| 子任务           | 说明                                                                   |
| ---------------- | ---------------------------------------------------------------------- |
| 创建 POC 页面    | 在 `/app/poc/page.tsx` 创建独立的 POC 验证页面                         |
| 文件选择         | 使用 `<input type="file" accept="video/mp4">` 选择本地 MP4 文件        |
| 元信息读取       | 通过 `<video>` 元素获取时长、分辨率；通过 `File` 对象获取文件名、大小  |
| 写入虚拟文件系统 | 使用 `fetchFile` + `ffmpeg.writeFile()` 将视频写入 FFmpeg 内存文件系统 |
| 执行压缩命令     | 使用 `ffmpeg.exec()` 执行 H.264 编码压缩命令                           |
| 进度监听         | 通过 `useFFmpeg` Hook 的 `progress` 状态展示压缩进度                   |
| 导出 Blob URL    | 使用 `ffmpeg.readFile()` 读取输出文件，转换为 Blob URL 供下载          |
| CRF 参数验证     | 测试不同 CRF 值（如 18/23/28/35）对输出体积的影响                      |

### 不包含

- 压缩比率滑杆 UI
- 预设按钮（80%/60%/40%/20%）
- 输入/输出对比预览
- 文件名自定义导出
- 错误边界处理组件

---

## 用户流程 / 交互说明

POC 页面为简化的单页流程：

```
1. 用户访问 /poc 页面
2. 点击"加载 FFmpeg"按钮，等待 WASM 加载完成
3. 点击"选择视频"按钮，选择本地 MP4 文件
4. 页面展示输入文件信息（文件名、大小、时长、分辨率）
5. 选择 CRF 值（下拉框或输入框，默认 23）
6. 点击"开始压缩"按钮
7. 页面展示压缩进度（百分比 + 已处理时间）
8. 压缩完成后展示输出文件信息（大小、压缩比）
9. 点击"下载"按钮，下载压缩后的 MP4 文件
```

---

## 功能需求（Functional Requirements）

| #     | 需求描述                                                            | 验证方式                               |
| ----- | ------------------------------------------------------------------- | -------------------------------------- |
| FR-1  | 页面在 `/poc` 路径可访问                                            | 浏览器访问 `http://localhost:3000/poc` |
| FR-2  | 点击"加载 FFmpeg"后，WASM 核心文件从 CDN 加载并初始化成功           | 控制台无报错，页面显示"加载完成"       |
| FR-3  | 文件选择器仅接受 `.mp4` 文件                                        | 文件选择对话框过滤非 MP4 文件          |
| FR-4  | 选择文件后，页面展示文件名、大小（MB）、时长（秒）、分辨率（宽×高） | UI 展示正确                            |
| FR-5  | 执行 `ffmpeg.writeFile()` 成功将视频写入虚拟文件系统                | 无报错，后续 `exec` 可读取文件         |
| FR-6  | 执行压缩命令时，进度以百分比形式实时更新                            | UI 展示 0%→100% 变化                   |
| FR-7  | 压缩命令使用 H.264 编码器（`-c:v libx264`）和指定 CRF 值            | 控制台日志显示正确命令                 |
| FR-8  | 音频默认启用压缩（`-c:a aac`）                                      | 输出文件包含音轨                       |
| FR-9  | 压缩完成后，输出文件大小可读取并展示                                | UI 展示输出大小和压缩比                |
| FR-10 | 点击"下载"可将输出文件保存到本地                                    | 文件可正常下载并播放                   |
| FR-11 | 不同 CRF 值产生不同的输出体积                                       | CRF 23 的体积 < CRF 18 的体积          |

---

## 边界与错误处理（Edge cases & errors）

| 场景               | 处理方式                                            |
| ------------------ | --------------------------------------------------- |
| FFmpeg 加载失败    | 页面展示错误信息，提示"FFmpeg 加载失败，请刷新重试" |
| 选择非 MP4 文件    | 通过 `accept` 属性在选择器层面过滤，若绕过则不处理  |
| 视频无法读取元信息 | 展示"时长/分辨率：未知"，不阻塞压缩流程             |
| 压缩过程中报错     | 控制台打印错误信息，页面展示"压缩失败"              |
| 内存不足           | 本 POC 不处理，建议使用小文件（<50MB）测试          |

---

## 验收标准（Acceptance Criteria）

- [ ] `/poc` 页面可正常访问且无控制台报错
- [ ] FFmpeg WASM 可成功加载（SharedArrayBuffer 检查通过）
- [ ] 可选择本地 MP4 文件并正确展示元信息（至少包含文件名和大小）
- [ ] 压缩过程中进度百分比正常更新（0% → 100%）
- [ ] 压缩完成后，输出文件大小 < 输入文件大小（使用默认 CRF 23）
- [ ] 输出文件可下载，下载后可正常播放
- [ ] 修改 CRF 值（如从 23 改为 35）后，输出体积明显变小

---

## 补充说明

### FFmpeg 压缩命令示例

```bash
ffmpeg -i input.mp4 -c:v libx264 -crf 23 -preset medium -c:a aac -b:a 128k output.mp4
```

**参数说明**：

- `-c:v libx264`：使用 H.264 视频编码器
- `-crf 23`：恒定质量因子，范围 0-51，值越小质量越高、体积越大（推荐范围 18-28）
- `-preset medium`：编码速度预设，影响压缩效率（可选 ultrafast/fast/medium/slow）
- `-c:a aac`：使用 AAC 音频编码器
- `-b:a 128k`：音频码率 128kbps

### 测试用 CRF 值

| CRF 值 | 预期效果             |
| ------ | -------------------- |
| 18     | 高质量，体积较大     |
| 23     | 默认平衡点（推荐）   |
| 28     | 中低质量，体积较小   |
| 35     | 低质量，体积明显减小 |

### 参考资料

- [FFmpeg.wasm 官方文档](https://github.com/ffmpegwasm/ffmpeg.wasm)
- [FFmpeg CRF 指南](https://trac.ffmpeg.org/wiki/Encode/H.264#crf)
- [useFFmpeg Hook](file:///Users/chao/mvp/compressmp4/lib/hooks/useFFmpeg.ts)

---

## 决策日志（Decision Log）

| 决策项      | 最终结论                             | 理由                                                              |
| ----------- | ------------------------------------ | ----------------------------------------------------------------- |
| 压缩策略    | 仅验证 CRF（恒定质量）               | POC 阶段聚焦验证基本压缩能力，目标码率精确控制属于 ISSUE-004 范畴 |
| POC UI 形态 | 独立 `/poc` Demo 页面                | 不影响主项目结构，便于验证和后续删除                              |
| 验收标准    | 验证体积变化（输出 < 输入）          | 证明压缩有效即可，精确容差验证属于后续任务                        |
| 元信息范围  | 基础信息（名称、大小、时长、分辨率） | PRD 仅要求这些信息，详细元信息可后续优化                          |
| 输入格式    | 仅支持 MP4                           | POC 聚焦核心流程，其他格式兼容性属于 ISSUE-004                    |
