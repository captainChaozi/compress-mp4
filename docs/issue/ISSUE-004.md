# ISSUE-004: 完整压缩功能（UI + 状态机 + 错误处理）

## 背景 / 问题

根据 [PRD](docs/prd.md) 定义，Offline MP4 Compressor 的核心价值在于无需上传即可在本地完成视频压缩。目前项目已完成基础架构（ISSUE-001）和 FFmpeg 环境配置（ISSUE-002）。
本任务旨在实现端到端的完整用户体验，包括文件选择、参数调整、压缩执行、进度反馈、结果预览及导出。这将把底层的 FFmpeg 能力转化为用户可用的产品功能。

---

## 目标 (Goals)

1.  实现符合 PRD 定义的 **5 状态 UI 状态机** (Empty -> Success -> Loading -> Error -> Success(Done))。
2.  完成核心压缩逻辑：基于 **CRF 模式** 的离线压缩，支持用户调节压缩比率。
3.  提供完整的用户交互：文件选择、进度展示（时间+百分比）、取消操作、结果预览、文件导出。
4.  实现稳健的错误处理：针对文件不支持、压缩失败等情况提供明确的用户提示和重试机制。

---

## 非目标 (Non-goals)

- **不**处理多文件批量压缩（遵循 PRD D1）。
- **不**支持 MP4 以外的导出格式。
- **不**实现复杂的云端同步或历史记录功能。
- **不**追求 100% 精确的体积控制（接受 ±10% 容差，优先保证速度）。

---

## 范围 (Scope)

### 包含

- **UI 组件开发**：
  - Hero 区域 / 文件选择器 (拖拽 + 点击)
  - 压缩设置面板 (滑杆 + 预设按钮)
  - 压缩状态面板 (进度条 + 已用时间 + 取消按钮)
  - 结果对比面板 (输入/输出信息 + 预览切换 + 导出)
- **逻辑实现**：
  - 视频元数据读取 (使用 `<video>` 标签)
  - FFmpeg 命令生成与执行 (单 Pass CRF 策略)
  - Web Worker 进度消息解析 (Time -> Percentage)
  - Blob URL 生成与下载
- **状态管理**：
  - 使用 `useReducer` 或状态机库管理 5 个核心状态的流转。

### 不包含

- 后端 API 开发 (纯客户端实现)。
- PWA 安装配置 (后续优化项)。

---

## 用户流程 / 交互说明

详见 `docs/prd.md` 第 3.1 节及状态机定义。
**核心路径**：
打开页面 (S0) -> 选择视频 -> 解析成功 (S1) -> 调整比率 (60%) -> 点击开始 -> 压缩中 (S2) -> 完成 (S4) -> 预览/导出。

---

## 功能需求 (Functional Requirements)

### FR-1: 文件选择与元数据

- **FR-1.1**: 用户可选择本地视频文件，支持拖拽和点击。允许格式：`video/*, .mp4, .mov, .mkv, .webm, .avi`。
- **FR-1.2**: 选择后立即通过 `<video>` 标签加载并读取 `duration` (时长), `videoWidth`, `videoHeight`。
- **FR-1.3**: 读取文件 `size` 和 `name`。
- **FR-1.4**: 若元数据读取失败，进入 Error 状态。

### FR-2: 压缩参数设置

- **FR-2.1**: 提供滑杆：范围 1% - 100%，步进 1%。
- **FR-2.2**: 提供预设按钮：20%, 40%, 60% (默认), 80%。
- **FR-2.3**: 滑杆与按钮联动，更新 `target_ratio`。

### FR-3: 压缩执行 (Core)

- **FR-3.1**: 点击“开始压缩”触发 FFmpeg 命令。
- **FR-3.2**: **压缩策略** (Decision Q1): 使用单 Pass CRF 模式。
  - 估算公式：`CRF = 51 - (TargetRatio * 51)` 或基于经验值的映射表 (e.g., 60% approx CRF 23-28)。_注：开发阶段需微调映射逻辑以在“体积/画质”间取得平衡。_
- **FR-3.3**: **分辨率策略** (Decision Q4/PRD D5):
  - Ratio >= 60%: 保持原分辨率。
  - 40% <= Ratio < 60%: 若原边长 > 1080p，限制最大边为 1920。
  - Ratio < 40%: 若原边长 > 720p，限制最大边为 1280。

### FR-4: 进度与取消

- **FR-4.1**: 展示“处理中”状态。
- **FR-4.2**: **进度展示** (Decision Q3): 同时显示 **已用时间** (mm:ss) 和 **预估百分比** (根据 FFmpeg `time` / `total_duration` 计算)。
- **FR-4.3**: 点击“取消”按钮，立即调用 `ffmpeg.terminate()`，重置状态回 S1。

### FR-5: 结果与导出

- **FR-5.1**: 压缩成功后展示：输出大小、实际压缩比、耗时。
- **FR-5.2**: **对比预览** (Decision Q5): 提供“查看原视频”和“查看新视频”两个按钮，控制同一个播放器源切换，或两个播放器互斥播放。
- **FR-5.3**: 点击“导出”：触发浏览器下载，默认文件名 `{OriginalName}-compressed.mp4`。
- **FR-5.4**: 用户可在输入框修改导出文件名。

---

## 边界与错误处理

- **E1**: FFmpeg 加载失败 -> 提示刷新重试。
- **E2**: 内存不足 (OOM) -> 捕获 FFmpeg 异常，提示“文件过大或设备内存不足，建议降低分辨率”。
- **E3**: 文件格式不支持 -> 提示“无法解码该格式，请尝试 MP4”。

---

## 验收标准 (Acceptance Criteria)

- [ ] **S0 -> S1**: 选择一个 .mov 文件，能正确显示时长、分辨率、大小。
- [ ] **S1 -> S2**: 点击开始，UI 变为处理中，计时器开始走动，进度条随时间推进。
- [ ] **Cancel**: 在 S2 点击取消，UI 立即变回 S1，且无残留文件。
- [ ] **S2 -> S4**: 压缩完成，展示结果卡片。
  - 实际体积应在目标体积的合理的估算范围内 (±10-20% 允许，视 CRF 映射准确度而定)。
  - 输出文件必须能播放。
- [ ] **Preview**: 点击“查看原视频”/“查看新视频”能正确切换画面内容。
- [ ] **Export**: 下载的文件名符合默认规则，且修改文件名后下载生效。
- [ ] **Error**: 当选择非视频文件或损坏文件时，能进入 S3 并提示错误。

---

## 决策日志 (Decision Log)

| ID  | 决策项     | 结论                   | 理由                                                                       |
| --- | ---------- | ---------------------- | -------------------------------------------------------------------------- |
| Q1  | 压缩模式   | **单 Pass CRF + 估算** | 优先保证速度 (2-pass 慢一倍)，且 CRF 对画质有保底，体积偏差在 MVP 可接受。 |
| Q2  | 元数据来源 | **`<video>` 标签**     | 无需等待 WASM 即可快速响应 UI，提升体验。                                  |
| Q3  | 进度展示   | **时间 + 百分比**      | 提供更明确的等待预期。                                                     |
| Q4  | 分辨率策略 | **静态规则阶梯**       | 简单可预测，避免为了体积目标过度重试导致的长时间等待。                     |
| Q5  | 预览交互   | **按钮切换源**         | 实现简单，避免双播放器同步和性能开销。                                     |
